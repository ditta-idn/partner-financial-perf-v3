<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Channel Partner — Financial Performance (Plotly Rev 5)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
  <style>
    :root{
      --aug:#1f77b4; /* Aug blue */
      --sep:#ff7f0e; /* Sep orange */
      --oct:#2ca02c; /* Oct green */
      --nov:#d62728; /* Nov red (current) */
      --target:#6b7280; /* gray */
      --projection:#8b5cf6; /* violet */
      --ink:#111827;
    }
    .p-plot{width:100%; height:360px;}
    .p-plot.tall{height:420px;}
    .card{background:#fff; border:1px solid #eef2f7; border-radius:16px; padding:16px;}
    .filter-bar{display:flex; gap:.5rem; overflow-x:auto; padding:.5rem; align-items:center;}
    .filter-bar select, .filter-bar input{border:1px solid #e5e7eb; border-radius:.5rem; padding:.4rem .5rem; font-size:.9rem; white-space:nowrap;}
    .btn{background:#111827; color:white; padding:.45rem .8rem; border-radius:.6rem;}
  </style>
</head>
<body class="bg-gray-50 text-gray-800">
  <header class="px-6 py-5 bg-white border-b">
    <h1 class="text-2xl md:text-3xl font-bold">Channel Partner — Financial Performance (Plotly Rev 5)</h1>
  </header>

  <!-- Horizontal Filters -->
  <section class="bg-white/60 border-b">
    <div class="filter-bar px-4">
      <label class="text-sm">Country
        <select id="f_country">
          <option>All</option><option>ID</option><option>PH</option><option>TH</option><option>MY</option><option>VN</option>
        </select>
      </label>
      <label class="text-sm">Partner
        <select id="f_category">
          <option>All</option><option>VC Partner</option><option>Referral Partner</option><option>AM Managed Partner</option>
          <option>Distribution Partner</option><option>TPI Partner</option><option>Embedded Partner</option>
        </select>
      </label>
      <label class="text-sm">Agreement
        <select id="f_agreement"><option>All</option><option>Revenue Sharing</option><option>Non Revenue Sharing</option></select>
      </label>
      <label class="text-sm">Industry
        <select id="f_industry"><option>Digital Products</option><option>Entertainment</option><option>Financial Services</option>
          <option>Non Profit</option><option>Travel & Hospitality</option><option>Property</option><option>Restaurant</option>
          <option>Retail</option><option>Services</option><option>Others</option></select>
      </label>
      <label class="text-sm">CPM
        <select id="f_cpm"><option>All</option><option>Charisse</option><option>OT</option><option>Hanna</option><option>Rizky</option></select>
      </label>
      <label class="text-sm">Product
        <select id="f_product"><option>All</option><option>Cards</option><option>VA</option><option>QR Code</option><option>eWallet</option><option>Direct Debit</option></select>
      </label>
      <label class="text-sm">Lead
        <select id="f_salesflow"><option>All</option><option>Self Serve</option><option>CPM</option></select>
      </label>
      <label class="text-sm">Marketing
        <select id="f_marketing"><option>All</option><option>Campaign</option><option>Non Marketing</option></select>
      </label>
      <label class="text-sm">Merchant Age
        <select id="f_age"><option>All</option><option>less than 6 months transaction</option><option>more than 6 months transactions</option></select>
      </label>
      <label class="text-sm">BIDs
        <input id="f_bids" placeholder="BID-001; BID-002" />
      </label>
      <label class="text-sm">From <input id="f_from" type="date"/></label>
      <label class="text-sm">To <input id="f_to" type="date"/></label>
      <button id="apply" class="btn">Apply</button>
    </div>
  </section>

  <!-- KPI cards -->
  <section class="px-6 py-3">
    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
      <div class="card"><div class="text-xs text-gray-500">Current Month Target</div><div id="kpi_target" class="text-2xl font-bold">—</div></div>
      <div class="card"><div class="text-xs text-gray-500">Month-to-date Actual Revenue (Current)</div><div id="kpi_mtd_actual" class="text-2xl font-bold">—</div></div>
      <div class="card"><div class="text-xs text-gray-500">Last Month Revenue</div><div id="kpi_last_month" class="text-2xl font-bold">—</div></div>
    </div>
  </section>

  <main class="px-6 pb-16 space-y-10 mt-2">
    <!-- ===== Revenue ===== -->
    <section>
      <h2 class="text-lg font-semibold mb-3">Revenue</h2>
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <div class="card"><h3 class="font-semibold">A. Net Revenue vs Target (MTD cumulative)</h3><div id="netVsTarget" class="p-plot"></div></div>
        <div class="card"><h3 class="font-semibold">Gross Revenue — MTD comparison</h3><div id="grossMTD" class="p-plot"></div></div>
        <div class="card"><h3 class="font-semibold">Net Net revenue — Monthly by Partner</h3><p class="text-sm text-gray-500 mb-2">Stacked Column</p><div id="nnrMonthlyStack" class="p-plot tall"></div></div>
        <div class="card"><h3 class="font-semibold">Net Net Revenue — MTD comparison</h3><div id="nnrMonthlyLine" class="p-plot"></div></div>
        <div class="card"><h3 class="font-semibold">Net Net Revenue — Quarterly Breakdown</h3><p class="text-sm text-gray-500 mb-2">Treemap</p><div id="nnrQuarterTreemap" class="p-plot tall"></div></div>
        <div class="card"><h3 class="font-semibold">Net Revenue — MTD comparison</h3><div id="netMonthlyLine" class="p-plot"></div></div>
      </div>
    </section>

    <!-- ===== TPV ===== -->
    <section>
      <h2 class="text-lg font-semibold mb-3">TPV</h2>
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-6">
        <div class="card"><h3 class="font-semibold">TPV — MTD comparison</h3><div id="tpvMTD" class="p-plot"></div></div>
      </div>
    </section>

    <!-- ===== Margin (pairs with month pickers) ===== -->
    <section>
      <h2 class="text-lg font-semibold mb-3">Margin</h2>
      <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 items-start">
        <div class="card"><h3 class="font-semibold">Net Net Margin — MoM</h3><p class="text-sm text-gray-500 mb-2">Column • 12 months</p><div id="nnmMoM" class="p-plot"></div></div>
        <div class="card"><div class="flex items-center justify-between"><h3 class="font-semibold">Net Net Margin — Monthly • Waterfall</h3><select id="sel_nnm" class="border rounded-md p-1 text-sm"><option>Jan</option><option>Feb</option><option>Mar</option><option>Apr</option><option>May</option><option>Jun</option><option>Jul</option><option>Aug</option><option>Sep</option><option>Oct</option><option selected>Nov</option><option>Dec</option></select></div><div id="nnmWaterfall" class="p-plot"></div></div>
        <div class="card"><h3 class="font-semibold">Net Margin — MoM</h3><p class="text-sm text-gray-500 mb-2">Column • 12 months</p><div id="nmMoM" class="p-plot"></div></div>
        <div class="card"><div class="flex items-center justify-between"><h3 class="font-semibold">Net Margin — Monthly • Waterfall</h3><select id="sel_nm" class="border rounded-md p-1 text-sm"><option>Jan</option><option>Feb</option><option>Mar</option><option>Apr</option><option>May</option><option>Jun</option><option>Jul</option><option>Aug</option><option>Sep</option><option>Oct</option><option selected>Nov</option><option>Dec</option></select></div><div id="nmWaterfall" class="p-plot"></div></div>
        <div class="card"><h3 class="font-semibold">Gross Margin — MoM</h3><p class="text-sm text-gray-500 mb-2">Column • 12 months</p><div id="gmMoM" class="p-plot"></div></div>
        <div class="card"><div class="flex items-center justify-between"><h3 class="font-semibold">Gross Margin — Monthly • Waterfall</h3><select id="sel_gm" class="border rounded-md p-1 text-sm"><option>Jan</option><option>Feb</option><option>Mar</option><option>Apr</option><option>May</option><option>Jun</option><option>Jul</option><option>Aug</option><option>Sep</option><option>Oct</option><option selected>Nov</option><option>Dec</option></select></div><div id="gmWaterfall" class="p-plot"></div></div>
      </div>
    </section>
  </main>

  <script>
  // ---------- Data generation ----------
  function seededRng(seed){ let t = seed; return () => { t = Math.imul(1664525, t + 1013904223) % 4294967296; return (t>>>0)/4294967296; }; }
  const catsAll = ["Alliance Partner","Embedded Partner","Referral Partner","VC Partner","AM Managed Partner","Distribution Partner","Referral Others","TPI"];
  function monthDays(){ return Array.from({length:30}, (_,i)=>i+1); }
  function series(seed, base, slope){ const r=seededRng(seed); let y=0; return monthDays().map(()=>{ y += slope + (r()-0.5)*base; return Math.max(0,y); }); }
  function seedFromFilters(obj){ const s = Object.values(obj).join("|"); let h=0; for (let i=0;i<s.length;i++){ h=(h*31 + s.charCodeAt(i))>>>0; } return h; }

  function buildData(filters){
    const k = seedFromFilters(filters);
    const months = ["Aug","Sep","Oct","Nov"];
    const net={}, gross={}, nnr={}, tpv={};
    months.forEach((m,i)=>{
      net[m]   = series(1000+k+i, 6000, 90000);
      gross[m] = series(2000+k+i, 8000, 120000);
      nnr[m]   = series(3000+k+i, 5000, 75000);
      tpv[m]   = series(4000+k+i, 70000, 3500000/30);
    });
    const target = series(5000+k, 5000, 88000);
    const projection = target.map((v,i)=> v*1.08 + i*1200);
    const nnrMonthlyStack = ["Jan","Feb","Mar","Apr","May","Jun"].map((m,mi)=>{ const row={month:m}; catsAll.forEach((c,ci)=> row[c] = 8000 + ((k%(ci+3))+mi*500) + (ci*1200)); return row; });
    const q3 = catsAll.map((c,ci)=>({name:c, value: 80000 + ((k%(ci+5))*10000) + ci*15000 }));
    const months12 = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const margins = months12.map((m,mi)=>({month:m, gross: 18+(mi%5)*3, net: 10+(mi%4)*3, netnet: 6+(mi%3)*3}));
    function waterfallFor(monthIdx, mult){ let cum=0; const r=seededRng(9000 + k + monthIdx*37 + Math.round(mult*10)); const x=[],measure=[],y=[],text=[]; catsAll.forEach((c,i)=>{ const sign = r()>0.2?1:-1; const val = ((1+(i%5))*mult*(0.8+r()))*sign; x.push(c); measure.push("relative"); y.push(val); text.push((val>0?"+":"")+val.toFixed(1)+"%"); cum+=val; }); x.push("Total"); measure.push("total"); y.push(0); text.push(cum.toFixed(1)+"%"); return {x,measure,y,text}; }
    return {months, net, gross, nnr, tpv, target, projection, nnrMonthlyStack, q3, margins, waterfallFor};
  }

  const layoutBase = {margin:{l:60,r:30,t:26,b:46}, paper_bgcolor:"white", plot_bgcolor:"white", font:{color:"var(--ink)"}, showlegend:true};

  function renderAll(){
    const filters = {
      country: f_country.value, category: f_category.value, agreement: f_agreement.value, industry: f_industry.value,
      cpm: f_cpm.value, product: f_product.value, salesflow: f_salesflow.value, marketing: f_marketing.value,
      age: f_age.value, bids: f_bids.value||"", from: f_from.value||"", to: f_to.value||""
    };
    const D = buildData(filters);
    const days = monthDays();

    // KPI cards
    const tEnd = D.target[D.target.length-1];
    const curEnd = D.net["Nov"][D.net["Nov"].length-1];
    const lastMonthEnd = D.net["Oct"][D.net["Oct"].length-1];
    kpi_target.textContent = "S$ " + Math.round(tEnd).toLocaleString();
    kpi_mtd_actual.textContent = "S$ " + Math.round(curEnd).toLocaleString();
    kpi_last_month.textContent = "S$ " + Math.round(lastMonthEnd).toLocaleString();

    // Helper to draw 4-month comparison with legend
    function comparison(container, seriesMap, isCurrency=true){
      Plotly.newPlot(container, [
        {type:"scatter", mode:"lines", name:"Aug 25", x:days, y:seriesMap["Aug"], line:{color:"var(--aug)", width:2}},
        {type:"scatter", mode:"lines", name:"Sep 25", x:days, y:seriesMap["Sep"], line:{color:"var(--sep)", width:2}},
        {type:"scatter", mode:"lines", name:"Oct 25", x:days, y:seriesMap["Oct"], line:{color:"var(--oct)", width:2}},
        {type:"scatter", mode:"lines", name:"Nov 25", x:days, y:seriesMap["Nov"], line:{color:"var(--nov)", width:3}},
      ], {...layoutBase, yaxis: isCurrency?{tickprefix:"S$", separatethousands:true}:{separatethousands:true}, xaxis:{title:"Created day of month"}});
    }

    // A. Net vs Target + Projection
    const netTraces = [
      {type:"scatter", mode:"lines", name:"Aug 25", x:days, y:D.net["Aug"], line:{color:"var(--aug)", width:2}},
      {type:"scatter", mode:"lines", name:"Sep 25", x:days, y:D.net["Sep"], line:{color:"var(--sep)", width:2}},
      {type:"scatter", mode:"lines", name:"Oct 25", x:days, y:D.net["Oct"], line:{color:"var(--oct)", width:2}},
      {type:"scatter", mode:"lines", name:"Nov 25", x:days, y:D.net["Nov"], line:{color:"var(--nov)", width:3}},
      {type:"scatter", mode:"lines", name:"Target (cur mo.)", x:days, y:D.target, line:{color:"var(--target)", width:3, dash:"dash"}},
      {type:"scatter", mode:"lines", name:"Projection (cur mo.)", x:days, y:D.projection, line:{color:"var(--projection)", width:3, dash:"dot"}}
    ];
    Plotly.newPlot("netVsTarget", netTraces, {...layoutBase, yaxis:{tickprefix:"S$", separatethousands:true}, xaxis:{title:"Created day of month"}});

    comparison("grossMTD", D.gross, true);
    comparison("nnrMonthlyLine", D.nnr, true);
    comparison("netMonthlyLine", D.net, true);

    // TPV
    Plotly.newPlot("tpvMTD", [
      {type:"scatter", mode:"lines", name:"Aug 25", x:days, y:D.tpv["Aug"], line:{color:"var(--aug)", width:2}},
      {type:"scatter", mode:"lines", name:"Sep 25", x:days, y:D.tpv["Sep"], line:{color:"var(--sep)", width:2}},
      {type:"scatter", mode:"lines", name:"Oct 25", x:days, y:D.tpv["Oct"], line:{color:"var(--oct)", width:2}},
      {type:"scatter", mode:"lines", name:"Nov 25", x:days, y:D.tpv["Nov"], line:{color:"var(--nov)", width:3}},
    ], {...layoutBase, yaxis:{separatethousands:true}, xaxis:{title:"Created day of month"}});

    // NNR Stacked + Treemap
    const nnrStack = catsAll.map((c,i)=>({
      type:"bar", name:c, x: D.nnrMonthlyStack.map(r=>r.month), y: D.nnrMonthlyStack.map(r=>r[c])
    }));
    Plotly.newPlot("nnrMonthlyStack", nnrStack, {...layoutBase, barmode:"stack", yaxis:{tickprefix:"S$", separatethousands:true}, xaxis:{title:"Month"}});
    const total = D.q3.reduce((a,b)=>a+b.value,0);
    Plotly.newPlot("nnrQuarterTreemap", [{
      type:"treemap",
      labels:["Q3", ...D.q3.map(d=>d.name)],
      parents:["", ...D.q3.map(_=>"Q3")],
      values:[total, ...D.q3.map(d=>d.value)],
    }], {...layoutBase});

    // MoM columns
    function col(container, key, color){
      Plotly.newPlot(container, [{
        type:"bar", x: D.margins.map(d=>d.month), y: D.margins.map(d=>d[key]), marker:{color: color},
        hovertemplate:"%{y:.0f}%<extra></extra>"
      }], {...layoutBase, yaxis:{ticksuffix:"%"}});
    }
    col("nnmMoM", "netnet", "#60a5fa");
    col("nmMoM", "net", "#fb923c");
    col("gmMoM", "gross", "#34d399");

    // Waterfalls with distinct +/- colors
    function wfRender(container, monthSel, mult){
      const idx = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"].indexOf(monthSel.value);
      const d = D.waterfallFor(idx, mult);
      const base = d.x.map((_,i)=> (d.measure[i]==="total") ? "#111111" : (d.y[i] >= 0 ? "#16a34a" : "#ef4444"));
      Plotly.newPlot(container, [{
        type:"waterfall", x:d.x, measure:d.measure, y:d.y, text:d.text, textposition:"outside",
        decreasing:{marker:{color:"#ef4444"}}, increasing:{marker:{color:"#16a34a"}},
        totals:{marker:{color:"#111111"}}, connector:{line:{color:"#9ca3af"}},
      }], {...layoutBase, yaxis:{ticksuffix:"%"}});
    }
    wfRender("nnmWaterfall", sel_nnm, 1.0);
    wfRender("nmWaterfall", sel_nm, 1.2);
    wfRender("gmWaterfall", sel_gm, 1.6);

    sel_nnm.onchange = ()=> wfRender("nnmWaterfall", sel_nnm, 1.0);
    sel_nm.onchange  = ()=> wfRender("nmWaterfall",  sel_nm,  1.2);
    sel_gm.onchange  = ()=> wfRender("gmWaterfall",  sel_gm,  1.6);

    // Resize safety
    window.addEventListener('resize', ()=>{
      ["netVsTarget","grossMTD","nnrMonthlyStack","nnrMonthlyLine","nnrQuarterTreemap","netMonthlyLine","tpvMTD","nnmMoM","nmMoM","gmMoM","nnmWaterfall","nmWaterfall","gmWaterfall"].forEach(id=>{
        const el=document.getElementById(id); if(el) Plotly.Plots.resize(el);
      });
    });
  }

  document.getElementById("apply").addEventListener("click", renderAll);
  document.addEventListener("DOMContentLoaded", renderAll);
  </script>
</body>
</html>
